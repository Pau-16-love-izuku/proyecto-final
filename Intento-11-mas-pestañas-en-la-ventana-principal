#mi intento 11:
#segui agregando pesta√±as a la misma ventana para que el trabajador pueda seleccionar mas libremente su area de trabajo, el puesto, etc
#aunque tiene el peque√±o detalle de que le movi y ya no guarda y registra automaticamente los datos, ni tampoco los limpia, asi que lo arreglare
#corregi el codigo para que ya guarde los datos, pero por error borre algunas de sus caracteristicas, asi que lo arreglare

import tkinter as tk
from tkinter import ttk, messagebox
from datetime import datetime, timedelta

trabajadores = []  # lista de dicts, en vez de tu dict con clave tupla
LIMITE_POR_TURNO = 2
RETARDOS_PARA_FALTA = 3
intentos = 0

def rango_fechas(inicio, fin):
    inicio = datetime.strptime(inicio, "%Y-%m-%d")
    fin = datetime.strptime(fin, "%Y-%m-%d")
    return [(inicio + timedelta(days=i)).strftime("%Y-%m-%d") for i in range((fin - inicio).days + 1)]

def validar_vacaciones(turno, fechas):
    conteo = {f: 0 for f in fechas}
    for t in trabajadores:
        if t["turno"] == turno:
            for f in t["vacaciones"]:
                if f in conteo:
                    conteo[f] += 1
                    if conteo[f] >= LIMITE_POR_TURNO:
                        return False, f
    return True, None

def limpiar_campos_entrada():
    entry_nombre_control.delete(0, tk.END)
    entry_hora_llegada.delete(0, tk.END)

def limpiar_campos_registro():
    for w in [entry_control, entry_nombre, entry_edad, entry_curp, entry_nss, entry_telefono, entry_domicilio]:
        w.delete(0, tk.END)
    combo_genero.set('')
    combo_puesto.set('')
    combo_area.set('')
    combo_jornada.set('')
    combo_turno.set('')

def guardar_trabajador():
    if not entry_nombre.get() or not combo_turno.get():
        messagebox.showerror("Error", "Nombre y Turno son obligatorios.")
        return
    t = {
        "control": entry_control.get(),
        "nombre": entry_nombre.get(),
        "edad": entry_edad.get(),
        "genero": combo_genero.get(),
        "curp": entry_curp.get(),
        "nss": entry_nss.get(),
        "telefono": entry_telefono.get(),
        "domicilio": entry_domicilio.get(),
        "puesto": combo_puesto.get(),
        "area": combo_area.get(),
        "jornada": combo_jornada.get(),
        "turno": combo_turno.get(),
        "asistencias": [],
        "vacaciones": [],
        "retardos": 0,
        "faltas": 0
    }
    trabajadores.append(t)
    actualizar_listado()
    limpiar_campos_registro()
    messagebox.showinfo("√âxito", f"Trabajador {t['nombre']} registrado.")

def registrar_asistencia():
    nombre = entry_nombre_control.get().lower()
    llegada_str = entry_hora_llegada.get()
    try:
        llegada = datetime.strptime(llegada_str, "%H:%M")
    except:
        messagebox.showerror("Formato inv√°lido", "Usa HH:MM (24h).")
        return
    hoy = datetime.now().strftime("%Y-%m-%d")
    for t in trabajadores:
        if t["nombre"].lower() == nombre:
            if hoy in t["vacaciones"]:
                messagebox.showinfo("Vacaciones", f"{t['nombre']} est√° de vacaciones hoy.")
                return
            base = datetime.strptime("08:00", "%H:%M")
            diff = (llegada - base).total_seconds()/60
            tipo = "Puntual" if diff <= 10 and diff >= 0 else "Antes de tiempo" if diff < 0 else "Retardo"
            if tipo == "Retardo":
                t["retardos"] += 1
                if t["retardos"] >= RETARDOS_PARA_FALTA:
                    t["faltas"] += 1
                    t["retardos"] = 0
                    tipo += " (se registr√≥ una falta)"
            t["asistencias"].append({"fecha": hoy, "tipo": tipo})
            actualizar_listado()
            messagebox.showinfo("Registrado", f"Asistencia registrada: {tipo}")
            text_area.insert(tk.END, f"[ENTRADA] {t['nombre']} - {hoy} {llegada_str} | {tipo}\n")
            return
    messagebox.showerror("No encontrado", "Trabajador no encontrado.")

def registrar_vacaciones():
    nombre = entry_vac_nombre.get().lower()
    inicio = entry_vac_inicio.get()
    fin = entry_vac_fin.get()
    try:
        fechas = rango_fechas(inicio, fin)
    except:
        messagebox.showerror("Error", "Fechas inv√°lidas AAAA-MM-DD.")
        return
    for t in trabajadores:
        if t["nombre"].lower() == nombre:
            ok, conflicto = validar_vacaciones(t["turno"], fechas)
            if not ok:
                messagebox.showwarning("Conflicto", f"Turno '{t['turno']}' ya agotado el {conflicto}.")
                return
            t["vacaciones"] += fechas
            actualizar_listado()
            messagebox.showinfo("√âxito", "Vacaciones registradas.")
            return
    messagebox.showerror("No encontrado", "Trabajador no encontrado.")

def actualizar_listado():
    tree_listado.delete(*tree_listado.get_children())
    for t in trabajadores:
        tree_listado.insert('', 'end', values=(
            t["nombre"], t["genero"], t["edad"], t["turno"], t["jornada"],
            len(t["asistencias"]), t["retardos"], t["faltas"], len(t["vacaciones"])
        ))


def guardar_registro_archivo():
    with open("registro_trabajadores.txt", "a", encoding="utf-8") as f:
        for t in trabajadores:
            for a in t["asistencias"]:
                f.write(f"{t['nombre']} ({t['control']}) | Fecha: {a['fecha']} | Tipo: {a['tipo']} | Jornada: {t['jornada']} | Puesto: {t['puesto']} | √Årea: {t['area']}\n")

def verificar_contrasena():
    global intentos
    if entry_contrasena.get() == "hospital":
        login.destroy()
        abrir_app()
    else:
        intentos += 1
        if intentos < 3:
            messagebox.showerror("Error", "Contrase√±a incorrecta")
        else:
            messagebox.showerror("Acceso denegado", "Demasiados intentos")
            login.destroy()

def abrir_login():
    bienvenida.destroy()
    global login, entry_contrasena
    login = tk.Tk()
    login.title("Verificaci√≥n de contrase√±a"); login.geometry("400x200")
    tk.Label(login, text="Ingrese contrase√±a:").pack(pady=10)
    entry_contrasena = tk.Entry(login, show="*"); entry_contrasena.pack()
    tk.Button(login, text="Entrar", command=verificar_contrasena).pack(pady=10)

def abrir_app():
    global entry_control, entry_nombre, entry_edad, entry_curp, entry_nss, entry_telefono, entry_domicilio
    global combo_genero, combo_puesto, combo_area, combo_jornada, combo_turno
    global entry_nombre_control, entry_hora_llegada
    global entry_vac_nombre, entry_vac_inicio, entry_vac_fin
    global tree_listado, text_area

    root = tk.Tk(); root.title("Sistema de Registro - Hospital")
    nb = ttk.Notebook(root); nb.pack(fill="both", expand=True)

    f_reg = ttk.Frame(nb); nb.add(f_reg, text="Registro")
    labels = [("N√∫mero control",0),("Nombre",1),("Edad",2),("G√©nero",3),
              ("CURP",4),("NSS",5),("Tel√©fono",6),("Domicilio",7),
              ("Puesto",8),("√Årea",9),("Jornada",10),("Turno",11)]
    for txt,row in labels:
        tk.Label(f_reg, text=txt+":").grid(row=row, column=0,sticky="e")
    entry_control = tk.Entry(f_reg); entry_control.grid(row=0,column=1)
    entry_nombre = tk.Entry(f_reg); entry_nombre.grid(row=1,column=1)
    entry_edad = tk.Entry(f_reg); entry_edad.grid(row=2,column=1)
    combo_genero = ttk.Combobox(f_reg, values=["Masculino","Femenino"]); combo_genero.grid(row=3,column=1)
    entry_curp = tk.Entry(f_reg); entry_curp.grid(row=4,column=1)
    entry_nss = tk.Entry(f_reg); entry_nss.grid(row=5,column=1)
    entry_telefono = tk.Entry(f_reg); entry_telefono.grid(row=6,column=1)
    entry_domicilio = tk.Entry(f_reg); entry_domicilio.grid(row=7,column=1)
    combo_puesto = ttk.Combobox(f_reg, values=["Enfermero/a","M√©dico/a","Camillero/a","Limpieza","Administrativo"]); combo_puesto.grid(row=8,column=1)
    combo_area = ttk.Combobox(f_reg, values=["Urgencias","Pediatr√≠a","Quir√≥fano","Farmacia","Consulta externa"]); combo_area.grid(row=9,column=1)
    combo_jornada = ttk.Combobox(f_reg, values=["Lunes a Viernes","Lunes a S√°bado","Fines de semana","Turno corrido"]); combo_jornada.grid(row=10,column=1)
    combo_turno = ttk.Combobox(f_reg, values=["Ma√±ana","Tarde","Noche"]); combo_turno.grid(row=11,column=1)
    tk.Button(f_reg, text="Guardar trabajador", command=guardar_trabajador).grid(row=12,column=0,columnspan=2,pady=10)

    f_as = ttk.Frame(nb); nb.add(f_as, text="Asistencias")
    tk.Label(f_as, text="Nombre:").grid(row=0,column=0); entry_nombre_control = tk.Entry(f_as); entry_nombre_control.grid(row=0,column=1)
    tk.Label(f_as, text="Hora llegada HH:MM:").grid(row=1,column=0); entry_hora_llegada = tk.Entry(f_as); entry_hora_llegada.grid(row=1,column=1)
    tk.Button(f_as, text="Registrar asistencia", command=registrar_asistencia).grid(row=2,column=0,columnspan=2,pady=10)

    f_vac = ttk.Frame(nb); nb.add(f_vac, text="Vacaciones")
    tk.Label(f_vac, text="Nombre:").grid(row=0,column=0); entry_vac_nombre = tk.Entry(f_vac); entry_vac_nombre.grid(row=0,column=1)
    tk.Label(f_vac, text="Inicio AAAA-MM-DD:").grid(row=1,column=0); entry_vac_inicio = tk.Entry(f_vac); entry_vac_inicio.grid(row=1,column=1)
    tk.Label(f_vac, text="Fin AAAA-MM-DD:").grid(row=2,column=0); entry_vac_fin = tk.Entry(f_vac); entry_vac_fin.grid(row=2,column=1)
    tk.Button(f_vac, text="Registrar vacaciones", command=registrar_vacaciones).grid(row=3,column=0,columnspan=2,pady=10)

    f_list = ttk.Frame(nb); nb.add(f_list, text="Listados")
    cols = ("Nombre","G√©nero","Edad","Turno","Jornada","Asistencias","Retardos","Faltas","Vacaciones")
    tree_listado = ttk.Treeview(f_list, columns=cols, show="headings")
    for c in cols: tree_listado.heading(c, text=c); tree_listado.column(c, width=100)
    tree_listado.pack(fill="both", expand=True)

    f_hist = ttk.Frame(nb); nb.add(f_hist, text="Historial")
    text_area = tk.Text(f_hist, height=15); text_area.pack(fill="both", expand=True, padx=10, pady=10)

    root.protocol("WM_DELETE_WINDOW", lambda: [guardar_registro_archivo(), root.destroy()])
    root.mainloop()

bienvenida = tk.Tk()
bienvenida.title("Bienvenido al hospital Osamu üíñ")
bienvenida.geometry("600x300")
tk.Label(bienvenida, text="Bienvenido al sistema de registro del hospital Osamu", font=("Times New Roman", 16)).pack(pady=20)
tk.Button(bienvenida, text="Presione para continuar", command=abrir_login).pack(pady=10)
bienvenida.mainloop()
